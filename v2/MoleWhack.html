<!DOCTYPE html>
<html lang="en">
	<head>
		<title>MoleWhack</title>
		<script src="engine/misc/JumpStart.js"></script>

		<script>
			loadJumpStart({
				"appID": "MoleWhack",
				"multiuserOnly": true,
				"enclosureOnly": true,
				"sceneScale": 3.0,
				"debug": {"showCursorPlanes": false}
			});

			jumpStart.addEventListener("precache", function()
			{
				// Async
				jumpStart.loadModels(["models/smasher", "models/table", "models/mole", "models/gold"]).then( function()
				{
					jumpStart.doneCaching();
				});

				// true	: SYNCHRONOUS
				// false: ASYNCHRONOUS (must call JumpStart.doneCaching)
				return false;
			});

			function moleSpawn(isInitialSync)
			{
				this.userData.oldHits = this.syncData.hits;
				this.userData.isPeeking = false;
				this.userData.hasBeenHit = false;
				this.userData.topDelayMax = 1.2;
				this.userData.topDelay = this.userData.topDelayMax;
				this.userData.maxDeltaY = 7.0;
				this.userData.direction = 0;
				moles.push(this);
			}

			function moleTick()
			{
				if( this.userData.oldHits !== this.syncData.hits )
				{
					var maxParticles = 8;
					var i, particle;
					for( i = 0; i < maxParticles; i++ )
					{
						particle = jumpStart.spawnInstance("models/gold");
						particle.position.copy(this.position);
						particle.quaternion.copy(this.quaternion);

						var scale = Math.random();
						if( scale < 0.5 )
							scale = 0.5;

						particle.scale.multiplyScalar(scale);

						var randoX = 3.0 * Math.random();
						if( Math.random() > 0.5 )
							randoX *= -1.0;

						var randoY = 3.0 * Math.random();
						if( Math.random() > 0.5 )
							randoY *= -1.0;

				//		if( randoY < 0 )
				//			randoY = 0;

						var randoZ = 3.0 * Math.random();
						if( Math.random() > 0.5 )
							randoZ *= -1.0;

						particle.translateX(randoX);

						if( randoY > 0 )
							particle.translateY(randoY);

						particle.translateZ(randoZ);

						var oldQuaternion = this.quaternion.clone();
						this.lookAt(particle.position);
						particle.quaternion.copy(this.quaternion);
						this.quaternion.copy(oldQuaternion);

						particle.userData.shock = 0.2;
						particle.userData.life = 0.1;
						particle.scale.multiplyScalar(4.0);

						particle.addEventListener("tick", function()
						{
							this.userData.shock -= jumpStart.deltaTime;

							if( this.userData.shock <= 0.0 )
							{
								if( this.userData.hasOwnProperty("will") )
									this.userData.will -= 1.0 * jumpStart.deltaTime;

								if( !this.userData.hasOwnProperty("direction") || this.userData.will <= 0)
								{
									var randoPitch = Math.PI * Math.random();
									if( Math.random() > 0.5 )
										randoPitch *= -1.0;

									var randoYaw = Math.PI * Math.random();
									if( Math.random() > 0.5 )
										randoYaw *= -1.0;

									var randoRoll = Math.PI * Math.random();
									if( Math.random() > 0.5 )
										randoRoll *= -1.0;

									this.userData.direction = new THREE.Vector3(randoPitch, randoYaw, randoRoll);
									this.userData.will = 3.0 * Math.random();
								}

								this.userData.life -= jumpStart.deltaTime;
								if( this.userData.life <= 0 )
								{
									this.scale.x -= 6.0 * jumpStart.deltaTime;
									this.scale.y -= 6.0 * jumpStart.deltaTime;
									this.scale.z -= 6.0 * jumpStart.deltaTime;
								}

								this.rotateX(this.userData.direction.x * jumpStart.deltaTime);
								this.rotateY(this.userData.direction.y * jumpStart.deltaTime);
								this.rotateZ(this.userData.direction.z * jumpStart.deltaTime);

								this.translateZ(15.0 * jumpStart.deltaTime);
								this.position.y += 10.0 * jumpStart.deltaTime;

								if( this.scale.x <= 0.1 )
									jumpStart.removeInstance(this);
							}
							else
							{
								this.translateZ(60.0 * jumpStart.deltaTime);
							}
						});

						this.userData.oldHits = this.syncData.hits;
					}
				}

				if( this.ownerID !== jumpStart.localUser.userID )
					return;

				if( this.userData.direction !== 0 )
				{
					var amount = 16.0 * jumpStart.deltaTime * this.userData.direction;
					this.translateY(amount);

					if( this.userData.direction > 0 && this.position.distanceTo(this.syncData.originalPosition) >= this.userData.maxDeltaY )
					{
						// just hit max
						//this.userData.direction = -1.0;
						this.userData.direction = 0;
						this.userData.isPeeking = true;
						this.sync();
					}
					else if( this.userData.direction < 0 && this.position.distanceTo(this.syncData.originalPosition) < 1.0 )
					{
						// just hit min
						this.userData.direction = 0;
						this.userData.hasBeenHit = false;
						this.position.copy(this.syncData.originalPosition);
						this.sync();
					}
				}
				else if( this.userData.isPeeking )
				{
					this.userData.topDelay -= jumpStart.deltaTime;
					if( this.userData.topDelay <= 0 )
					{
						this.userData.topDelay = this.userData.topDelayMax;
						this.userData.direction = -1.0;
						this.userData.isPeeking = false;
					}
				}
			}

			var moles = [];
			function spawnAllMoles()
			{
				var table = jumpStart.scene.getObjectByName("table");
				var translation = new THREE.Vector3();

				translation.set(0, 0, -2.3);
				spawnAMole(table, translation);

				translation.set(19.1, 0, -2.3);
				spawnAMole(table, translation);

				translation.set(-19.1, 0, -2.3);
				spawnAMole(table, translation);

				translation.set(-9.7, -3.3, 10.5);
				spawnAMole(table, translation);

				translation.set(9.7, -3.3, 10.5);
				spawnAMole(table, translation);
			}

			function spawnAMole(table, translation)
			{
				var mole = jumpStart.spawnInstance("models/mole");
				mole.position.copy(table.position);
				mole.quaternion.copy(table.quaternion);
				mole.translateX(translation.x);
				mole.translateY(translation.y);
				mole.translateZ(translation.z);
				mole.addEventListener("spawn", moleSpawn);
				mole.addEventListener("tick", moleTick);
				mole.syncData.originalPosition = mole.position.clone();
				mole.applyBehavior("lerpSync", {"speed": 30.0});
				mole.applyBehavior("autoSync");
				mole.rotateX(0.3);
				mole.syncData.hits = 0;
				mole.sync();
			}

			jumpStart.addEventListener("initialize", function()
			{
				var table = jumpStart.spawnInstance("models/table");
				table.name = "table";
				table.position.y += 48.0;
				table.addEventListener("spawn", tableSpawn);
				table.sync();

				// true	: SYNCHRONOUS
				// false: ASYNCHRONOUS (must call JumpStart.doneInitializing)
				return true;
			});

			function tableSpawn()
			{
				var imageURL = "assets/MoleWhack/misc/nameBackground.jpg";

				var thisTable = this;
				var image = new Image();
				this.userData.imageElem = image;
				image.addEventListener("load", function(e)
				{
					var smasher = jumpStart.scene.getObjectByName("smasher");
					var name = (!!smasher) ? smasher.syncData.ownerName : "CLICK TABLE TO PLAY";
					var nameCard = jumpStart.spawnTextPlane({"backgroundImageElem": this, "width": 52.5, "height": 9, "fontSize": 4, "text": name, "color": "#ffffff"});
					nameCard.position.copy(thisTable.position);
					nameCard.quaternion.copy(thisTable.quaternion);
					nameCard.translateZ(-13.5);
					nameCard.translateY(14.7);
					thisTable.userData.nameCard = nameCard;
				});
				image.src = imageURL;

				var scoreCard = jumpStart.spawnTextPlane({"width": 15.0, "height": 6.5, "fontSize": 5, "text": "8888", "color": "#ff0000"});
				scoreCard.position.copy(this.position);
				scoreCard.quaternion.copy(this.quaternion);
				scoreCard.translateZ(-13.5);
				scoreCard.translateY(35.13);
				scoreCard.translateX(14.8);
				this.userData.scoreCard = scoreCard;
			}

			function smasherSpawn(isInitialSync)
			{
				var table = jumpStart.scene.getObjectByName("table");

				this.userData.oldScore = -1;
				this.userData.table = table;

				if( this.ownerID !== jumpStart.localUser.userID )
					return;

				if( !isInitialSync )
					jumpStart.updateTextPlane(table.userData.nameCard, {"backgroundImageElem": table.userData.imageElem, "width": 52.5, "height": 9, "fontSize": 4, "text": this.syncData.ownerName, "color": "#ffffff"});

				this.userData.table = table;
				this.syncData.swinging = 0;
				this.userData.swingRot = 0;
				this.userData.maxSwingRot = Math.PI / 3.0;

				var hitPoint = jumpStart.spawnInstance(null, {"parent": this});
				hitPoint.translateZ(-15.0);
				this.userData.hitPoint = hitPoint;
			}

			var gameDelay = 0;
			var gameTimer = 60.0;
			function smasherTick()
			{
				if( this.syncData.score !== this.userData.oldScore )
				{
					// update the scoreCard
					var table = this.userData.table;
					jumpStart.updateTextPlane(table.userData.scoreCard, {"width": 15.0, "height": 6.5, "fontSize": 5, "text": this.syncData.score, "color": "#ff0000"});

					this.userData.oldScore = this.syncData.score;
				}

				if( this.ownerID !== jumpStart.localUser.userID || moles.length === 0 || moles[0].ownerID !== jumpStart.localUser.userID )
					return;

				gameTimer -= jumpStart.deltaTime;

				if( gameTimer <= 0 )
				{
					gameTimer = 60.0;
					gameDelay = 5.0;
					removeAllMoles();
					jumpStart.removeInstance(this);
					return;
				}

				var smashSpeed = 4.0;
				var deltaRot = 0;
				var needsSync = false;

				if( this.syncData.swinging === 1 )
					deltaRot += smashSpeed * jumpStart.deltaTime;
				else if( this.syncData.swinging === -1 )
					deltaRot -= smashSpeed * jumpStart.deltaTime;

				if( jumpStart.localUser.cursorHit )
				{
					this.position.copy(this.userData.table.position);
					this.quaternion.copy(this.userData.table.quaternion)
					this.translateZ(45.0);
					this.translateY(30.0);

					this.lookAt(jumpStart.localUser.cursorHit.scaledPoint);

					var zAmount = 30.0 + this.position.distanceTo(jumpStart.localUser.cursorHit.scaledPoint) - 46

					this.translateZ(zAmount);
					this.translateY(-5.0);

					this.rotateX(Math.PI / 2.0);
				}

				if( deltaRot + this.userData.swingRot > this.userData.maxSwingRot )
				{
					deltaRot = this.userData.maxSwingRot - this.userData.swingRot;

					this.syncData.swinging = -1;
					needsSync = true;
				}
				else if( deltaRot + this.userData.swingRot < 0 )
				{
					deltaRot = -this.userData.swingRot;

					this.syncData.swinging = 0;
					needsSync = true;
				}

				if( this.syncData.swinging !== 0 )
				{
					this.userData.swingRot += deltaRot;

					if( !jumpStart.localUser.cursorHit )
						this.rotateX(deltaRot);
					else
						this.rotateX(this.userData.swingRot);
				}

				// Test for collisions
				var scaledPoint = new THREE.Vector3().setFromMatrixPosition(this.userData.hitPoint.matrixWorld).multiplyScalar(1 / jumpStart.options.sceneScale).sub(jumpStart.world.position);

				var i;
				for( i in moles )
				{
					if( moles[i].userData.hasBeenHit )
						continue;

					if( moles[i].userData.direction === 0 && !moles[i].userData.isPeeking )
						continue;

					if( moles[i].position.distanceTo(scaledPoint) < 8.0 )
					{
						moles[i].userData.direction = -1.0;
						moles[i].userData.topDelay = moles[i].userData.topDelayMax;
						moles[i].userData.hasBeenHit = true;
						moles[i].syncData.hits += 1;
						moles[i].sync();

						this.syncData.score += 1;

						needsSync = true;
						break;
					}
				}

				if( needsSync )
					this.sync();
			}

			function smasherRemove()
			{
				var table = jumpStart.scene.getObjectByName("table");
				var nameCard = table.userData.nameCard;

				jumpStart.updateTextPlane(nameCard, {"backgroundImageElem": table.userData.imageElem, "width": 52.5, "height": 9, "fontSize": 4, "text": "THANKS FOR PLAYING", "color": "#ffffff"});

				if( moles.length > 0 && moles[0].ownerID !== jumpStart.localUser.userID )
					removeAllMoles();

				if( this.ownerID === jumpStart.localUser.userID )
					mySmasher = null;
			}

			function removeAllMoles()
			{
				var i;
				for( i in moles )
					jumpStart.removeInstance(moles[i]);

				moles = [];
			}

			var mySmasher = null;
			function spawnSmasher()
			{
				var table = jumpStart.scene.getObjectByName("table");

				var smasher = jumpStart.spawnInstance("models/smasher");
				smasher.syncData.swinging = 0;
				smasher.syncData.numSwings = 0;
				smasher.syncData.score = 0;
				smasher.name = "smasher";
				smasher.syncData.ownerName = jumpStart.localUser.displayName;
				smasher.position.copy(table.position);
				smasher.quaternion.copy(table.quaternion)
				smasher.translateZ(25.0);
				smasher.translateY(10.0);
				smasher.rotateX(Math.PI / 3.4);

				smasher.addEventListener("spawn", smasherSpawn);
				smasher.addEventListener("remove", smasherRemove);
				smasher.addEventListener("tick", smasherTick);
				smasher.applyBehavior("autoRemoval");
				smasher.applyBehavior("lerpSync", {"speed": 50.0});
				smasher.applyBehavior("autoSync");

				mySmasher = smasher;

				mySmasher.sync();

				spawnAllMoles();
				startMoleSequence();
			}

			function randomMoleJump()
			{
				var validMoles = [];
				var i;
				for( i in moles )
				{
					if( moles[i].userData.direction === 0 && !moles[i].userData.isPeeking )
						validMoles.push(moles[i]);
				}

				var randomIndex = Math.floor(Math.random() * validMoles.length);

				var mole = validMoles[randomIndex];
				mole.userData.direction = 1.0;
			}

			function startMoleSequence()
			{
				var moleJumpHandle0 = setInterval(randomMoleJump, 900);
			}

			function swingMySmasher()
			{
				mySmasher.syncData.swinging = 1;
				mySmasher.sync();
			}

			jumpStart.addEventListener("tick", function()
			{
				if( gameDelay > 0 )
				{
					gameDelay -= jumpStart.deltaTime;

					if( gameDelay <= 0 )
					{
						gameDelay = 0;
						return;
					}
				}
			});

			var debugElem;
			jumpStart.addEventListener("ready", function()
			{
				debugElem = document.createElement("div");
				debugElem.isDone = false;
				debugElem.style.cssText = "position: fixed; top: 0; left: 0; font-size: 20px; font-weight: 900; max-height: 700px; overflow-y: auto; overflow-x: hidden;";
				document.body.appendChild(debugElem);

				var tableTop = jumpStart.spawnCursorPlane({"width": 64.0, "height": 40.0});
				tableTop.blocksLOS = true;
				tableTop.position.y += 50.0;
				tableTop.position.z += 7.0;
				tableTop.rotateX(Math.PI / 1.77);
				tableTop.position.y -= 1.5;
				
				tableTop.addEventListener("cursordown", function()
				{
					if( mySmasher )
						swingMySmasher();
					else if( !!!jumpStart.scene.getObjectByName("smasher") && gameDelay === 0 )
						spawnSmasher();
				});
				// true	: SYNCHRONOUS
				// false: ASYNCHRONOUS (must call JumpStart.run)
				return true;
			});
		</script>
	</head>

	<body>
	</body>
</html>