<!DOCTYPE html>
<html lang="en">
	<head>
		<title>TicTacToe</title>
		<script src="http://www.jumpstartsdk.com/live/v2/engine/misc/appMenu.js" appid="TicTacToe" appurl="http://www.jumpstartsdk.com/live/v2/TicTacToe.html"></script>

		<script src="engine/misc/JumpStart.js"></script>

		<script>
			loadJumpStart({
				"appID": "TicTacToe",
				"enclosureOnly": true,
				"multiuserOnly": true,
				"debug": {"showCursorPlanes": true}
			});

			jumpStart.addEventListener("initialize", function()
			{
				var world = jumpStart.scene.getObjectByName("jumpStartWorld");
				world.syncData.moves = 0;
				world.syncData.nextMark = "";
				world.syncData.ownerName = "";
				world.syncData.marks = {
					"square0": "",
					"square1": "",
					"square2": "",
					"square3": "",
					"square4": "",
					"square5": "",
					"square6": "",
					"square7": "",
					"square8": ""
				};
				world.addEventListener("tick", worldTick);
				world.sync();
			});

			function worldTick()
			{
				if( !!!this.userData.previousMoves )
					this.userData.previousMoves = 0;

				if( this.userData.previousMoves !== this.syncData.moves )
				{
					this.userData.previousMoves = this.syncData.moves;

					if( this.ownerID !== jumpStart.localUser.userID )
					{
						// update the local board to match
						var elems = board.querySelectorAll("td");
						var x, elem;
						for( x in this.syncData.marks )
						{
							elem = elems[parseInt(x.charAt(x.length-1))];
							if( elem.innerHTML !== this.syncData.marks[x] )
							{
								makePlay(elem, this.syncData.marks[x]);
							}
						}
					}
				}
			}

			var board = null;
			jumpStart.addEventListener("ready", function()
			{
				board = document.getElementById("board");
				var elems = board.querySelectorAll("td");
				var i;
				for( i = 0; i < elems.length; i++ )
				{
					elems[i].addEventListener("click", function(e)
					{
						var world = jumpStart.scene.getObjectByName("jumpStartWorld");

						// If we are in a cat's game, clear the board before making our play
						var isFull = true;
						var x;
						for( x in world.syncData.marks )
						{
							if( world.syncData.marks[x] === "" )
							{
								isFull = false;
								break;
							}
						}

						if( isFull )
						{
							var i;
							var elems = board.querySelectorAll("td");
							for( i = 0; i < 9; i ++ )
							{
								world.syncData.marks["square" + i] = "";
								elems[i].innerHTML = "";
								elems[i].className = "";
							}
						}

						if( e.srcElement.innerHTML === "" || world.syncData.nextMark === "" )
							makePlay(e.srcElement);
					});

					elems[i].squareIndex = i;
				}

				// true	: SYNCHRONOUS
				// false: ASYNCHRONOUS (must call JumpStart.run)
				return true;
			});

			function makePlay(elem, givenMark)
			{
				var world = jumpStart.scene.getObjectByName("jumpStartWorld");

				var mark;
				if( !!givenMark )
					mark = givenMark;
				else
				{
					mark = world.syncData.nextMark;

					if( mark === "" )
					{
						mark = "X";

						// We are a new game, so we might need to clear the board
						if( world.syncData.moves > 0 )
						{
							var i;
							var elems = board.querySelectorAll("td");
							for( i = 0; i < 9; i ++ )
							{
								world.syncData.marks["square" + i] = "";
								elems[i].innerHTML = "";
								elems[i].className = "";
							}
						}
					}
				}

				world.syncData.marks["square" + elem.squareIndex] = mark;
				elem.innerHTML = mark;
				elem.className = "taken";

				// Check for TicTacToe
				var winningLines = [];

				if( world.syncData.marks.square0 !== "" &&
					world.syncData.marks.square0 === world.syncData.marks.square1 &&
					world.syncData.marks.square0 === world.syncData.marks.square2
				)
				{
					winningLines.push(
						[0, 1, 2]
					);
				}

				if( world.syncData.marks.square3 !== "" &&
					world.syncData.marks.square3 === world.syncData.marks.square4 &&
					world.syncData.marks.square3 === world.syncData.marks.square5
				)
				{
					winningLines.push(
						[3, 4, 5]
					);
				}

				if( world.syncData.marks.square6 !== "" &&
					world.syncData.marks.square6 === world.syncData.marks.square7 &&
					world.syncData.marks.square6 === world.syncData.marks.square8
				)
				{
					winningLines.push(
						[6, 7, 8]
					);
				}

				if( world.syncData.marks.square0 !== "" &&
					world.syncData.marks.square0 === world.syncData.marks.square3 &&
					world.syncData.marks.square0 === world.syncData.marks.square6
				)
				{
					winningLines.push(
						[0, 3, 6]
					);
				}

				if( world.syncData.marks.square1 !== "" &&
					world.syncData.marks.square1 === world.syncData.marks.square4 &&
					world.syncData.marks.square1 === world.syncData.marks.square7
				)
				{
					winningLines.push(
						[1, 4, 7]
					);
				}

				if( world.syncData.marks.square2 !== "" &&
					world.syncData.marks.square2 === world.syncData.marks.square5 &&
					world.syncData.marks.square2 === world.syncData.marks.square8
				)
				{
					winningLines.push(
						[2, 5, 8]
					);
				}

				if( world.syncData.marks.square0 !== "" &&
					world.syncData.marks.square0 === world.syncData.marks.square4 &&
					world.syncData.marks.square0 === world.syncData.marks.square8
				)
				{
					winningLines.push(
						[0, 4, 8]
					);
				}

				if( world.syncData.marks.square2 !== "" &&
					world.syncData.marks.square2 === world.syncData.marks.square4 &&
					world.syncData.marks.square2 === world.syncData.marks.square6
				)
				{
					winningLines.push(
						[2, 4, 6]
					);
				}

				if( winningLines.length > 0 )
				{
					// WE HAVE A WINNER
					var elems = board.querySelectorAll("td");
					var i, line, j;
					for( i = 0; i < winningLines.length; i++ )
					{
						line = winningLines[i];
						for( j = 0; j < line.length; j++ )
							elems[line[j]].className += " winner";
					}

					if( !!!givenMark )
						mark = "";
				}

				// Prepare for the next player to move
				if( !!!givenMark )
				{
					if( mark === "" )
						world.syncData.nextMark = "";
					else
						world.syncData.nextMark = (mark === "X") ? "O" : "X";

					world.syncData.moves += 1;
					world.ownerID = jumpStart.localUser.userID;	// to remember who made the last move
					world.syncData.ownerName = jumpStart.localUser.displayName;
					world.sync();
				}

				var statusElem = document.getElementById("status");
				if( world.syncData.nextMark !== "" )
					statusElem.innerHTML = world.syncData.nextMark + "'s turn";
				else if( world.syncData.moves > 0 )
					statusElem.innerHTML = world.syncData.ownerName + " wins!";
			}
		</script>
	</head>

	<style>
		#board
		{
			position: fixed;
			border: 4px solid #fff;
			bottom: 20px;
			left: 0;
			right: 0;
			height: 300px;
			width: 300px;
			margin-left: auto;
			margin-right: auto;
			font-size: 90px;
			font-family: Arial;
			font-weight: 900;
			line-height: 33%;
			text-shadow: 1px 1px #000, 1px -1px #000, -1px 1px #000, -1px -1px #000, 0px 1px #000, 0px -1px #000, 1px 0px #000, -1px 0px #000;
		}

		#board td
		{
			width: 33%;
			height: 33%;
			overflow: hidden;
			background-color: rgba(92, 170, 218, 0.5);
		}

		#board td:hover
		{
			cursor: pointer;
			background-color: rgba(255, 255, 255, 0.5);
		}

		#board td.taken:hover
		{
			background-color: rgba(92, 170, 218, 0.5);
		}

		.winner
		{
			background-color: #fff !important;
		}

		#status
		{
			position: fixed;
			bottom: 400px;
			width: 100%;
			font-size: 60px;
			font-family: Arial;
			font-weight: 900;
			text-shadow: 1px 1px #000, 1px -1px #000, -1px 1px #000, -1px -1px #000, 0px 1px #000, 0px -1px #000, 1px 0px #000, -1px 0px #000;
		}
	</style>

	<body>
		<div id="status"></div>
		<table id="board">
			<tr>
				<td></td>
				<td></td>
				<td></td>
			</tr><tr>
				<td></td>
				<td></td>
				<td></td>
			</tr><tr>
				<td></td>
				<td></td>
				<td></td>
			</tr>
		</table>
	</body>
</html>