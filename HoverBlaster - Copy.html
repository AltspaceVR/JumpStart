<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Hover Blaster</title>
		<script src="engine/misc/JumpStart.js"></script>

		<script>
			loadJumpStart({
				"appID": "HoverBlaster",
				"multiuserOnly": false,
				"sceneScale": 1.0,
				"scaleWithEnclosure": false,
				"debug": {"showCursorPlanes": false}
			});

			// globals
			var hawk;
			var planet;
			var segments = 13.0;

			// precache
			jumpStart.addEventListener("precache", function()
			{
				jumpStart.loadModels(["models/vivewand", "models/board", "models/rocks", "models/rocks_broken", "models/missile", "models/road", "models/hawk", "models/player_laser", "models/missilefull", "models/manualgun_base", "models/manualgun_base_broken", "models/explosion", "models/dome", "models/coin", "models/manualgun_tower", "models/manualgun_barrels", "models/enemy_laser"]).then( function()
				{
					jumpStart.doneCaching();
				});

				return false;	// ASYNCHRONOUS
			});

			// capture gamepad input
			jumpStart.addEventListener("gamepadbutton", function(e)
			{
				if( !!!hawk )
					return;

				if( jumpStart.gamepad.mapping === "steamvr" )
				{
					var preventButtons = [];

					if( typeof jumpStart.gamepad.preventDefault === "function" )
						jumpStart.gamepad.preventDefault([], preventButtons);

					if( !!planet && planet.userData.isActive )
					{
						if( e.buttonCode === 0 && e.value > 0.2 && !!hawk && hawk.userData.fireCooldown === 0 )
						{
							if( e.value === 1.0 )
								g_turbo = 2.0;
							else
								g_turbo = 1.0;

							hawk.userData.fireCooldown = 0.2;
							fireLaser.call(hawk);
						}
					}
					else if( !!planet && !!hawk && hawk.userData.wand.userData.triggerText.scale.x === 1 )
					{
						planet.userData.isActive = true;
						jumpStart.removeInstance(hawk.userData.wand.userData.triggerText);
						jumpStart.removeInstance(hawk.userData.wand);
					}
				}
			});

			function fireLaser()
			{
				if( !!!hawk )
					return;

				var laserOffsets = [{"x": 5, "y": 0, "z": 50}, {"x": -5, "y": 0, "z": 50}];
				var i, laserOffset, laser;
				for( i = 0; i < laserOffsets.length; i++ )
				{
					laser = jumpStart.spawnInstance("models/player_laser");
					laser.userData.power = 20.0;
					laser.position.copy(this.position);
					laser.quaternion.copy(this.quaternion);

					laserOffset = laserOffsets[i];
					laser.translateX(laserOffset.x * hawk.scale.x);
					laser.translateY(laserOffset.y * hawk.scale.x);
					laser.translateZ(laserOffset.z * hawk.scale.x);
					laser.scale.set(0.2, 0.2, 1.0);
					laser.scale.multiplyScalar(hawk.scale.x);
					laser.userData.age = 1.0;
//					laser.userData.target = jumpStart.syncedObjects[falcon.syncData.target];
					laser.addEventListener("tick", laserTick);
					laser.addEventListener("spawn", laserSpawn);
					laser.addEventListener("remove", laserRemove);
				}
			}

			var g_lasers = {};
			function laserSpawn()
			{
				g_lasers[this.uuid] = this;
			}

			function laserRemove()
			{
				delete g_lasers[this.uuid];
			}

			function laserTick()
			{
				this.userData.age += jumpStart.deltaTime;
				this.translateZ(30.0 * jumpStart.deltaTime * this.userData.age);

				// remove if outside of enclosure
				if( !jumpStart.isWorldPosInsideOfEnclosure(this.position) || this.position.distanceTo(new THREE.Vector3()) > planet.userData.radius * 3.0 )
				{
					jumpStart.removeInstance(this);
					return;
				}

				// remove if surface impact
				if( planet.position.distanceTo(this.position) < planet.userData.radius )
				{
					//if( enemy.ownerID === jumpStart.localUser.userID )
					//	enemy.userData.onDamage.call(enemy, this.userData.power);

					jumpStart.removeInstance(this);
					return;
				}
			}
/*
			function laserTick()
			{
				if( !!this.userData.target && !!this.userData.target.parent )
					this.lookAt(this.userData.target.position);

				this.translateZ(300.0 * jumpStart.deltaTime);

				if( !jumpStart.isWorldPosInsideOfEnclosure(this.position) )
				{
					jumpStart.removeInstance(this);
					return;
				}

				var i, enemy;
				for( i = 0; i < g_enemies.length; i++ )
				{
					enemy = g_enemies[i];

					if( enemy.position.distanceTo(this.position) < 30.0 )
					{
						if( enemy.ownerID === jumpStart.localUser.userID )
							enemy.userData.onDamage.call(enemy, this.userData.power);

						jumpStart.removeInstance(this);
						return;
					}
				}
			}
*/

			var timeline = [];
			/*
			timeline.push({
				"z": 1.0,
				"action": function()
				{
					var gun = jumpStart.spawnInstance(null, {"parent": planet});
					gun.userData.fireCooldown = 0.0;
					gun.addEventListener("spawn", gunSpawn);
					gun.addEventListener("tick", gunTick);
					gun.userData.health = 200.0;
					gun.userData.rotOffset = -planet.userData.rot;
					gun.rotation.x = gun.userData.rotOffset;
					gun.rotateX(-Math.PI / 2.0);

					var rotZ = Math.PI * 0.1;

					//var rotZ = Math.PI * 0.2 * Math.random();
					//rotZ *= (Math.random() > 0.5) ? 1.0 : -1.0;

					gun.rotateZ(rotZ);
					gun.translateY(planet.userData.radius);
					gun.scale.set(0.0001, 0.0001, 0.0001);
					gun.addEventListener("tick", rotFade);
					gun.addEventListener("tick", hitDetect);
				}
			});
*/

			function MakeText(words)
			{
				var params = {
					size: 12.0,
					height: 1,
					font: "helvetiker",
					curveSegments: 1
				};

				var geometry = new THREE.TextGeometry(words, params);
				var material = new THREE.MeshBasicMaterial({color:'white'});
				var mesh = new THREE.Mesh(geometry, material);

				geometry.computeBoundingBox();
				var displacement = new THREE.Vector3().copy(geometry.boundingBox.max).sub(geometry.boundingBox.min);

				var text = jumpStart.spawnInstance(null, {"parent": planet})

				var textMesh = jumpStart.spawnInstance(null, {"object": mesh, "parent": text})
				var offset = new THREE.Vector3().copy(displacement);
				offset.multiply(textMesh.scale);
				textMesh.position.set(-offset.x / 2.0, -offset.y / 2.0, -offset.z / 2.0);

				text.userData.rotOffset = -planet.userData.rot + (Math.PI / 2.0);
				text.rotation.x = text.userData.rotOffset;
				text.rotateX(-Math.PI / 1.5);

				text.translateY(planet.userData.radius + (displacement.y / 2.0) + 30.0);
				text.scale.set(0.0001, 0.0001, 0.0001);
				text.addEventListener("tick", rotFade);
			}

			function MakeRocks(rotZ)
			{
				var rocks = jumpStart.spawnInstance("models/rocks", {"parent": planet});
				rocks.userData.hitRadius = 20.0;
				rocks.userData.rotOffset = -planet.userData.rot;
				rocks.rotation.x = rocks.userData.rotOffset;
				rocks.rotateX(-Math.PI / 2.0);

				rocks.rotateZ(rotZ);
				rocks.translateY(planet.userData.radius);
				rocks.scale.set(0.0001, 0.0001, 0.0001);
				rocks.userData.health = 100.0;

				g_rocks.push(rocks);

				rocks.userData.kill = function()
				{
					var debris = jumpStart.spawnInstance("models/rocks_broken", {"parent": planet});
					debris.userData.rotOffset = this.userData.rotOffset;
					debris.userData.maxGrowScale = 1.0;
					debris.position.copy(this.position);
					debris.quaternion.copy(this.quaternion);
					debris.addEventListener("tick", rotFade);

					jumpStart.removeInstance(this);
				};

				rocks.addEventListener("remove", function()
				{
					g_rocks.splice(g_rocks.indexOf(this), 1);
				});

				rocks.addEventListener("tick", rotFade);
				rocks.addEventListener("tick", hitDetect);
			}

			var g_rocks = [];
			var intervals = {};

			function repositionRocks(obsticals)
			{
				var i, obstical, j, rock, y, direction;
				for( i = 0; i < obsticals.length; i++ )
				{
					obstical = obsticals[i];
					for( j = 0; j < g_rocks.length; j++ )
					{
						rock = g_rocks[j];
						if( rock.position.distanceTo(obstical.position) < 50.0 )
						{
							y = rock.position.distanceTo(new THREE.Vector3());

							direction = (rock.position.x < 0.0) ? -1.0 : 1.0;
							rock.position.set(0, 0, 0);
							rock.rotateZ(Math.PI / 5.0 * direction);
							rock.translateY(y);
							console.log("rock repositioned");
						}
					}
				}
			}

			timeline.push(
				{
					"z": 0.5,
					"action": function()
					{
						MakeText("STAGE 1");
					}
				},
				{
					"z": 0.75,
					"action": function()
					{
						MakeText("GO!");
						intervals["rocks"] = setInterval(function()
						{
							var rotZ = Math.PI * 0.2 * Math.random();
							rotZ *= (Math.random() > 0.5) ? 1.0 : -1.0;

							MakeRocks(rotZ);
/*
							var rocks = jumpStart.spawnInstance("models/rocks", {"parent": planet});
							rocks.userData.rotOffset = -planet.userData.rot;
							rocks.rotation.x = rocks.userData.rotOffset;
							rocks.rotateX(-Math.PI / 2.0);

							

							rocks.rotateZ(rotZ);
							rocks.translateY(planet.userData.radius);
							rocks.scale.set(0.0001, 0.0001, 0.0001);
							g_rocks.push(rocks);
							rocks.addEventListener("tick", rotFade);
							rocks.addEventListener("remove", function()
							{
								g_rocks.splice(g_rocks.indexOf(this), 1);
							});

//							var z = planet.userData.rot / (Math.PI * 2.0);
//							if( z > )
*/
						}, 1100);

						intervals["guns"] = setInterval(function()
						{
							var gun = jumpStart.spawnInstance(null, {"parent": planet});
							gun.userData.hitRadius = 20.0;
							gun.userData.fireCooldown = 0.0;
							gun.addEventListener("spawn", gunSpawn);
							gun.addEventListener("tick", gunTick);
							gun.userData.kill = function()
							{
								var debris = jumpStart.spawnInstance("models/manualgun_base_broken", {"parent": planet});
								debris.userData.rotOffset = this.userData.rotOffset;
								debris.userData.maxGrowScale = 1.0;
								debris.position.copy(this.position);
								debris.quaternion.copy(this.quaternion);
								debris.addEventListener("tick", rotFade);

								var coin = jumpStart.spawnInstance("models/coin", {"parent": planet});
								coin.userData.rotOffset = this.userData.rotOffset;
								coin.userData.maxGrowScale = 1.0;
								coin.position.copy(this.position);
								coin.quaternion.copy(this.quaternion);
								//coin.lookAt(planet.position);
								coin.translateY(20.0);
								//coin.rotateX(Math.PI / 2.0);
								//coin.position.y += 12;
								coin.scale.set(0.1, 0.1, 0.1);
								coin.addEventListener("tick", rotFade);
								coin.addEventListener("tick", coinTick);
								coin.addEventListener("tick", growTick);
								coin.addEventListener("spawn", coinSpawn);
								coin.addEventListener("remove", coinRemove);							
								//coin.sync();

								//var explosion = SpawnExplosion(this.position, 1.0);
								//explosion.quaternion.copy(this.quaternion);
								//explosion.translateY(20.0);

								jumpStart.removeInstance(this);
							};

							gun.userData.health = 200.0;
							gun.userData.rotOffset = -planet.userData.rot;
							gun.rotation.x = gun.userData.rotOffset;
							gun.rotateX(-Math.PI / 2.0);

							var rotZ = Math.PI * 0.2 * Math.random();
							rotZ *= (Math.random() > 0.5) ? 1.0 : -1.0;

							gun.rotateZ(rotZ);
							gun.translateY(planet.userData.radius);
							gun.scale.set(0.0001, 0.0001, 0.0001);
							gun.addEventListener("tick", rotFade);
							gun.addEventListener("tick", hitDetect);

							// reposition any rocks that are in the way
							repositionRocks([gun]);
						}, 3000);
					}
				},
				{
					"z": 1.5,
					"action": function()
					{
						return;
/*
						var gun = jumpStart.spawnInstance(null, {"parent": planet});
						gun.userData.fireCooldown = 0.0;
						gun.addEventListener("spawn", gunSpawn);
						gun.addEventListener("tick", gunTick);
						gun.userData.health = 200.0;
						gun.userData.rotOffset = -planet.userData.rot;
						gun.rotation.x = gun.userData.rotOffset;
						gun.rotateX(-Math.PI / 2.0);

						var rotZ = -Math.PI * 0.1;

						//var rotZ = Math.PI * 0.2 * Math.random();
						//rotZ *= (Math.random() > 0.5) ? 1.0 : -1.0;

						gun.rotateZ(rotZ);
						gun.translateY(planet.userData.radius);
						gun.scale.set(0.0001, 0.0001, 0.0001);
						gun.addEventListener("tick", rotFade);
						gun.addEventListener("tick", hitDetect);
						*/
					}
				}/*,
				{
					"z": 0.0,
					"action": function()
					{
						MakeRocks(Math.PI * 0.2);
						MakeRocks(Math.PI * -0.2);
					}
				},
				{
					"z": 0.05,
					"action": function()
					{
						MakeRocks(Math.PI * 0.1);
						MakeRocks(Math.PI * -0.1);	
					}
				},
				{
					"z": 0.1,
					"action": function()
					{
						MakeRocks(Math.PI * 0.1);
						MakeRocks(Math.PI * -0.1);	
					}
				}*/
			);

			jumpStart.addEventListener("ready", function()
			{
				planet = jumpStart.spawnInstance(null);
				planet.userData.isActive = false;//true;
				//planet.rotateX(Math.PI);
				planet.userData.radius = 118.0;
				planet.position.y += 90.0;//translateY(90.0);
				planet.userData.rot = Math.PI;
				planet.userData.plates = [];
				planet.userData.totalPlates = 0;

				planet.addEventListener("tick", function()
				{
					if( !this.userData.isActive )
						return;

					this.userData.rot += 0.3 * jumpStart.deltaTime;

					var z = this.userData.rot / (Math.PI * 2.0);
					var i;
					for( i = 0; i < timeline.length; i++ )
					{
						if( z >= timeline[i].z )
						{
							timeline[i].action();
							timeline.splice(i, 1);
							i = -1;
						}
					}
/*
					if( this.userData.rot > Math.PI * 2.0 )
					{
						this.userData.rot = (Math.PI * 2.0) - this.userData.rot;
						this.userData.totalPlates = 0;
					}
*/

					if( this.userData.rot > (Math.PI / segments) * this.userData.totalPlates )
					{
						var delta = ((Math.PI / segments) * this.userData.totalPlates) + (5.0 * Math.PI / segments);
						this.userData.totalPlates++;

						var plate;
						if( this.userData.plates.length < 15 )
						{
							plate = jumpStart.spawnInstance("models/road", {"parent": planet});
							this.userData.plates.push(plate);
						}
						else
						{
							plate = this.userData.plates[0];
							this.userData.plates.shift();
							this.userData.plates.push(plate);
						}

						plate.rotation.x = (Math.PI / 4.0) - delta;
					}

					this.rotation.x = this.userData.rot;
					this.updateMatrix();
				});

				var board = jumpStart.spawnInstance("models/board");
				board.position.copy(planet.position);
				board.quaternion.copy(planet.quaternion);

				var dome = jumpStart.spawnInstance("models/dome", {"parent": board});
				dome.scale.multiplyScalar(0.95);
				/*
				dome.blocksLOS = true;
				dome.addEventListener("cursordown", function()
				{
					planet.userData.isActive = true;
				});
				*/
/*
				var rocks = jumpStart.spawnInstance("models/rocks", {"parent": planet});
				rocks.userData.rotOffset = -planet.userData.rot;
				rocks.rotateX(-Math.PI / 2.0);
				rocks.rotateZ(Math.PI * 0.2);
				rocks.translateY(planet.userData.radius);
				rocks.addEventListener("tick", rotFade);
				*/
/*
				
*/
/*
				var missile = jumpStart.spawnInstance("models/missilefull", {"parent": planet});
				missile.rotateX(-Math.PI / 2.0);
				missile.rotateZ(Math.PI * -0.1);
				missile.translateY(planet.userData.radius);

				missile.userData.rotOffset = -planet.userData.rot;
				missile.addEventListener("tick", rotFade);
*/
				//missile.scale.multiplyScalar(0.5);

				//var floor = jumpStart.enclosureBoundary("floor");

				var ceiling = jumpStart.enclosureBoundary("ceiling");
				ceiling.scale.multiplyScalar(1.4);

				var north = jumpStart.enclosureBoundary("north");
				north.scale.multiplyScalar(1.4);

				var south = jumpStart.enclosureBoundary("south");
				south.scale.multiplyScalar(1.4);

				var east = jumpStart.enclosureBoundary("east");
				east.scale.multiplyScalar(1.4);

				var west = jumpStart.enclosureBoundary("west");
				west.scale.multiplyScalar(1.4);

				// spawn the player ship
				hawk = jumpStart.spawnInstance("models/hawk");
				hawk.userData.radius = 80.0;

				var sight = jumpStart.spawnInstance("models/player_laser", {"parent": hawk});
				sight.scale.set(0.1, 0.1, 10.0);
				sight.translateZ(150.0);
				hawk.userData.sight = sight;

				var geometry = new THREE.SphereGeometry( 60.0, 12, 12 );
				var material = new THREE.MeshBasicMaterial( {color: 0x7777ff} );
				material.transparent = true;
				material.opacity = 0.3;
				var sphere = new THREE.Mesh( geometry, material );
				var shield = jumpStart.spawnInstance(null, {"parent": hawk, "object": sphere});
				shield.addEventListener("tick", function()
				{
					if( this.scale.x > 0.0001 )
					{
						this.scale.multiplyScalar(0.99);

						if( this.scale.x < 0.5 )
							this.scale.set(0.0001, 0.0001, 0.0001);
					}
				});
				shield.scale.set(0.0001, 0.0001, 0.0001);
				hawk.userData.shield = shield;

				hawk.userData.shields = 1.0;
				hawk.userData.health = 100.0;

				hawk.userData.fireCooldown = 0;
				hawk.scale.multiplyScalar(0.4);
				hawk.addEventListener("tick", function()
				{
					if( !planet.userData.isActive )
						return;

					if( this.userData.fireCooldown > 0 )
						this.userData.fireCooldown -= jumpStart.deltaTime;

					if( this.userData.fireCooldown < 0 )
						this.userData.fireCooldown = 0;

					var position, quaternion;
					if( jumpStart.activeGamepadIndex > -1 && jumpStart.gamepad.mapping === "steamvr" )
					{
						var pos = jumpStart.gamepad.position;
						var rot = jumpStart.gamepad.rotation;
						//var gamepadMatrix = new THREE.Matrix4().set(pos.x, pos.y, pos.z, 0, rot.x, rot.y, rot.z, 0, 1, 1, 1, 0, 0, 0, 0, 0);
						//this.matrix.copy(gamepadMatrix);
						var position = new THREE.Vector3(jumpStart.gamepad.position.x, jumpStart.gamepad.position.y, jumpStart.gamepad.position.z);

						jumpStart.world.worldToLocal(position);

						this.position.copy(position);

						var quaternion = new THREE.Quaternion(jumpStart.gamepad.rotation.x, jumpStart.gamepad.rotation.y, jumpStart.gamepad.rotation.z, jumpStart.gamepad.rotation.w);

						this.quaternion.copy(quaternion);

						this.translateZ(17.0);
						this.rotateX(Math.PI / 4.0);
					}
				});

				hawk.translateY(180.0);
				hawk.rotateY(Math.PI);
				hawk.translateZ(-100.0);
				hawk.rotateX(Math.PI / -12.0);

				var wand = jumpStart.spawnInstance("models/vivewand", {"parent": hawk});
				wand.rotateX(Math.PI / -4.0);
				wand.translateZ(-40.0);
				wand.translateY(-8.0);
				wand.userData.direction = 1.0;
				wand.userData.maxScaleDelta = 0.3;
				wand.addEventListener("tick", function()
				{
					var delta = 1.0 * jumpStart.deltaTime * this.userData.direction;
					this.scale.add(new THREE.Vector3(delta, delta, delta));
					if( this.scale.x > 1.0 + this.userData.maxScaleDelta || this.scale.x < 1.0 - this.userData.maxScaleDelta )
					{
						var val = 1.0 + this.userData.maxScaleDelta * this.userData.direction;
						this.scale.set(val, val, val);
						this.userData.direction *= -1.0;
					}

					if( jumpStart.activeGamepadIndex > -1 && jumpStart.gamepad.mapping === "steamvr" )
					{
						var pos = jumpStart.gamepad.position;
						var rot = jumpStart.gamepad.rotation;
						//var gamepadMatrix = new THREE.Matrix4().set(pos.x, pos.y, pos.z, 0, rot.x, rot.y, rot.z, 0, 1, 1, 1, 0, 0, 0, 0, 0);
						//this.matrix.copy(gamepadMatrix);
						var position = new THREE.Vector3(jumpStart.gamepad.position.x, jumpStart.gamepad.position.y, jumpStart.gamepad.position.z);

						jumpStart.world.worldToLocal(position);

						var wandPos = this.getWorldPosition();
						jumpStart.world.worldToLocal(wandPos);

						if( position.distanceTo(wandPos) < 10.0 )
							this.userData.triggerText.scale.set(1, 1, 1);
						else
							this.userData.triggerText.scale.set(0.0001, 0.0001, 0.0001);
					}
				});

				var params = {
					size: 12.0,
					height: 1,
					font: "helvetiker",
					curveSegments: 1
				};

				var geometry = new THREE.TextGeometry("PULL TRIGGER", params);
				var material = new THREE.MeshBasicMaterial({color:'white'});
				var mesh = new THREE.Mesh(geometry, material);

				geometry.computeBoundingBox();
				var displacement = new THREE.Vector3().copy(geometry.boundingBox.max).sub(geometry.boundingBox.min);

				var textMesh = jumpStart.spawnInstance(null, {"object": mesh, "parent": hawk})
				var offset = new THREE.Vector3().copy(displacement);
				offset.multiply(textMesh.scale);
				textMesh.position.set(offset.x / 2.0, -offset.y / 2.0, -offset.z / 2.0);
				textMesh.rotateY(Math.PI);
				textMesh.translateY(25.0);
				textMesh.scale.set(0.0001, 0.0001, 0.0001);

				wand.userData.triggerText = textMesh;
				hawk.userData.wand = wand;

				return true;	// SYNCHRONOUS
			});

			function gunTick()
			{
				//var lookPos = this.userData.tower.worldToLocal(hawk.position.clone());
				//this.userData.tower.lookAt(hawk.position);
/*
				var targetPos = hawk.position.clone();
				planet.worldToLocal(targetPos);
				//targetPos.multiplyScalar(jumpStart.options.sceneScale);
				this.userData.base.worldToLocal(targetPos);
				targetPos.y = this.userData.tower.position.y;
				this.userData.tower.lookAt(targetPos);
				*/

				//var up = planet.position.clone();
				//up.sub(this.userData.base.position);
				//up.normalize();

				//this.userData.tower.up.copy(up);

				// tower yaw
				this.userData.tower.parent.updateMatrixWorld();
				THREE.SceneUtils.detach(this.userData.tower, this.userData.base, jumpStart.scene);
				var targetPos = hawk.position.clone();
				jumpStart.world.localToWorld(targetPos);
				this.userData.tower.lookAt(targetPos);//.multiplyScalar(jumpStart.options.sceneScale));
				this.userData.tower.updateMatrixWorld();
				THREE.SceneUtils.attach(this.userData.tower, jumpStart.scene, this.userData.base);
				this.userData.tower.rotation.x = 0;
				this.userData.tower.rotation.z = 0;

				// barrels pitch
				this.userData.barrels.parent.updateMatrixWorld();
				THREE.SceneUtils.detach(this.userData.barrels, this.userData.tower, jumpStart.scene);
				var targetPos = hawk.position.clone();
				jumpStart.world.localToWorld(targetPos);
				this.userData.barrels.lookAt(targetPos);//.multiplyScalar(jumpStart.options.sceneScale));
				this.userData.barrels.updateMatrixWorld();
				THREE.SceneUtils.attach(this.userData.barrels, jumpStart.scene, this.userData.tower);
				this.userData.barrels.rotation.y = 0;
				this.userData.barrels.rotation.z = 0;

				var pitchMin = -Math.PI / 3.0;
				var pitchMax = Math.PI / 7.0;

				//console.log(this.userData.barrels.rotation.x);
				if( this.userData.barrels.rotation.x > pitchMax )
					this.userData.barrels.rotation.x = pitchMax;
				else if( this.userData.barrels.rotation.x < pitchMin )
					this.userData.barrels.rotation.x = pitchMin;

				this.userData.fireCooldown -= jumpStart.deltaTime;

				if( this.userData.fireCooldown <= 0 )
				{
					this.userData.fireCooldown = 0.5;
					//PlayDynamicSound("legacy/v1/sounds/SpacePilot/laser0", 0.05, 2.0);
					gunFireLaser.call(this.userData.barrels, new THREE.Vector3(2.4, 0, 6.0), this, true);
					gunFireLaser.call(this.userData.barrels, new THREE.Vector3(-2.4, 0, 6.0), this, false);
				}
			}

			var g_turbo = 1.0;
			function gunFireLaser(offset, parent, explosive)
			{
				//offset.multiplyScalar(1 / jumpStart.options.sceneScale);

				parent.userData.fireCooldown = 1.5;

				//console.log("Spawn laser");
				var laser = jumpStart.spawnInstance("models/enemy_laser", {"parent": parent});
				//laser.quaternion.copy(parent.quaternion);

				//laser.userData.parent = parent;
				//laser.userData.explosive = explosive;

				parent.updateMatrixWorld();
				//this.updateMatrixWorld();
				laser.quaternion.copy(parent.quaternion);
				var position = this.getWorldPosition();//new THREE.Vector3().setFromMatrixPosition(this.matrixWorld);
				position.multiplyScalar(1 / jumpStart.options.sceneScale);
				//position.y -= jumpStart.world.position.y * jumpStart.options.sceneScale;
				//var quaternion = this.getWorldQuaternion();
				//vector.multiplyScalar(1.0 / jumpStart.options.sceneScale);

				//laser.worldToLocal(position);
				THREE.SceneUtils.detach(laser, this, jumpStart.scene);
				laser.position.copy(position);
				//laser.quaternion.copy(quaternion);

			//	THREE.SceneUtils.detach(laser, this, jumpStart.scene);
//laser.scale.set(10, 10, 10);
//return;
				laser.translateX(offset.x);
				laser.translateY(offset.y);
				laser.translateZ(offset.z);

				laser.scale.set(0.2, 0.2, 1.0);
				//laser.scale.set(10, 10, 10);
				//laser.rotateX(-Math.PI / 2.0);

				laser.userData.power = 10.0;

				laser.addEventListener("tick", function()
				{
					//console.log("ticker");
					this.translateZ(100 * jumpStart.deltaTime);

					var laserPosition = this.getWorldPosition();
					var planetPosition = planet.getWorldPosition();
					var hawkPosition = hawk.getWorldPosition();

					if( laserPosition.distanceTo(planetPosition) > 200.0 * jumpStart.options.sceneScale )
					{
						jumpStart.removeInstance(this);
						return;
					}

					//console.log(this.userData.parent.userData.target);

					var target = hawk;
					var dist = laserPosition.distanceTo(hawkPosition);

					var shieldVal = hawk.userData.shields;
					if( shieldVal < 0.5 )
						shieldVal = 0.5;

					if( dist < hawk.userData.radius * shieldVal )//planet.userData.radius * hawk.scale.z * shieldVal )
					{
						//if( this.userData.explosive )
						//{
							//SpawnExplosion(this.position, 0.5);
						//	if( this.userData.parent.JumpStart.ownerId === g_localUser.userId )
						//		CauseAsteroidDamage(this.userData.power);
						//}

						SpawnExplosion(jumpStart.world.worldToLocal(laserPosition), 0.2);

						if( hawk.userData.shields > 0.5 )
						{
								hawk.userData.shield.scale.set(1, 1, 1);
								hawk.userData.shield.scale.multiplyScalar(hawk.userData.shields);
						}

						hawk.userData.shields -= this.userData.power * 0.01;

						jumpStart.removeInstance(this);
						return;

						//g_scene.remove(this);
						//console.log("close!");
//						g_galaxy.remove(this);
					}

					//*/
				});
			}

			function gunSpawn()
			{
				var base = jumpStart.spawnInstance("models/manualgun_base", {"parent": this});

				var tower = jumpStart.spawnInstance("models/manualgun_tower", {"parent": base});
				tower.translateY(8.5);
				/*
				tower.addEventListener("tick", function()
				{
					var lookPos = planet.worldToLocal(hawk.position.clone());
					this.lookAt(hawk.position);
				});
*/

				var barrels = jumpStart.spawnInstance("models/manualgun_barrels", {"parent": tower});
				barrels.translateY(4.0);
				barrels.translateZ(2.0);

				this.userData.base = base;
				this.userData.tower = tower;
				this.userData.barrels = barrels;
			}

			function hitDetect()
			{
				function causeDamage(amount)
				{
					this.userData.health -= amount;

					if( this.userData.health <= 0 )
					{
						this.userData.kill.call(this);
						this.removeEventListener(arguments.callee);
						return;
					}
				}
				
				var x, laser;
				for( x in g_lasers )
				{
					laser = g_lasers[x];
					if( laser.getWorldPosition().distanceTo(this.getWorldPosition()) < this.userData.hitRadius * jumpStart.options.sceneScale )
					{
						SpawnExplosion(laser.position, 0.2);
						jumpStart.removeInstance(laser);

						causeDamage.call(this, laser.userData.power);
					}
				}

				// check for ship collision
				var thisPosition = this.getWorldPosition();
				var planetPosition = planet.getWorldPosition();
				var hawkPosition = hawk.getWorldPosition();

				var target = hawk;
				var dist = thisPosition.distanceTo(hawkPosition);

				var shieldVal = hawk.userData.shields;
				if( shieldVal < 0.5 )
					shieldVal = 0.5;

				if( dist < hawk.userData.radius * shieldVal )
				{
					SpawnExplosion(jumpStart.world.worldToLocal(thisPosition), 0.2);

					if( hawk.userData.shields > 0.5 )
					{
						hawk.userData.shield.scale.set(1, 1, 1);
						hawk.userData.shield.scale.multiplyScalar(hawk.userData.shields);
					}

//					var damage = hawk.userData.health + ;
//					if( hawk.userData.shields > damage)

					hawk.userData.shields -= this.userData.health * 0.01;

					//SpawnExplosion(laser.position, 0.2);
					jumpStart.removeInstance(laser);

					causeDamage.call(this, this.userData.health);

//					jumpStart.removeInstance(this);
//					return;

					//g_scene.remove(this);
					//console.log("close!");
//						g_galaxy.remove(this);
				}
			}

			function rotFade()
			{
				if( !!this.userData.fading )
				{
					this.scale.multiplyScalar(0.9);

					if( this.scale.x < 0.1 )
						jumpStart.removeInstance(this);

					return;
				}

				var rot = this.userData.rotOffset + planet.userData.rot;
				var max = Math.PI - (Math.PI / segments);

				if( max - rot < 0.3 )
					this.userData.fading = true;
				else if( this.scale.x < 1.0 )
				{
					if( this.scale.x < 0.01 )
						this.scale.set(0.02, 0.02, 0.02);

					this.scale.multiplyScalar(1.1);

					if( this.scale.x > 1.0 )
						this.scale.set(1, 1, 1);
				}
			}

			function SpawnExplosion(position, scale, sound)
			{
				//var soundFile = ( typeof sound === "undefined" ) ? "legacy/v1/sounds/SpacePilot/explosion0" : sound;

				//console.log(arguments);
				//JumpStart.playSound(soundFile, 0.5);

				var explosion = jumpStart.spawnInstance("models/explosion");
				explosion.position.copy(position);

				explosion.userData.scaleSize = 0.001;
				explosion.userData.scaleDirection = 1;
				explosion.userData.maxScale = scale;
				explosion.scale.set(explosion.userData.scaleSize, explosion.userData.scaleSize, explosion.userData.scaleSize);

				explosion.addEventListener("tick", function()
				{
					if( this.userData.scaleDirection === 1 )
					{
						this.userData.scaleSize += 1.0 * jumpStart.deltaTime;
						if( this.userData.scaleSize >= this.userData.maxScale )
							this.userData.scaleDirection = -1;
					}
					else
					{
						this.userData.scaleSize -= 2.0 * jumpStart.deltaTime;

						if( this.userData.scaleSize <= 0.001 )
						{
							jumpStart.removeInstance(this);
							return;
						}
					}

					this.scale.set(this.userData.scaleSize, this.userData.scaleSize, this.userData.scaleSize);
					this.rotateY(5.0 * jumpStart.deltaTime);
					this.rotateX(15.0 * jumpStart.deltaTime);
				});

				//return explosion;
			}

			function coinRemove()
			{
			//	jumpStart.playSound("sounds/coin_collect", 1.0, false);
/*
				var maxParticles = 8;
				var i, particle;
				for( i = 0; i < maxParticles; i++ )
				{
					particle = jumpStart.spawnInstance("models/gold");
					particle.position.copy(this.position);
					particle.rotation.copy(this.rotation);

					var scale = Math.random();
					if( scale < 0.5 )
						scale = 0.5;

					particle.scale.multiplyScalar(scale);

					var randoX = 3.0 * Math.random();
					if( Math.random() > 0.5 )
						randoX *= -1.0;

					var randoY = 3.0 * Math.random();
					if( Math.random() > 0.5 )
						randoY *= -1.0;

			//		if( randoY < 0 )
			//			randoY = 0;

					var randoZ = 3.0 * Math.random();
					if( Math.random() > 0.5 )
						randoZ *= -1.0;

					particle.translateX(randoX);

					if( randoY > 0 )
						particle.translateY(randoY);

					particle.translateZ(randoZ);

					this.lookAt(particle.position);
					particle.rotation.copy(this.rotation);

					particle.userData.shock = 0.15;
					particle.userData.life = 0.1;
					particle.scale.multiplyScalar(10.0);

					particle.addEventListener("tick", function()
					{
						this.userData.shock -= jumpStart.deltaTime;

						if( this.userData.shock <= 0.0 )
						{
							if( this.userData.hasOwnProperty("will") )
								this.userData.will -= 1.0 * jumpStart.deltaTime;

							if( !this.userData.hasOwnProperty("direction") || this.userData.will <= 0)
							{
								var randoPitch = Math.PI * Math.random();
								if( Math.random() > 0.5 )
									randoPitch *= -1.0;

								var randoYaw = Math.PI * Math.random();
								if( Math.random() > 0.5 )
									randoYaw *= -1.0;

								var randoRoll = Math.PI * Math.random();
								if( Math.random() > 0.5 )
									randoRoll *= -1.0;

								this.userData.direction = new THREE.Vector3(randoPitch, randoYaw, randoRoll);
								this.userData.will = 3.0 * Math.random();
							}

							this.userData.life -= jumpStart.deltaTime;
							if( this.userData.life <= 0 )
							{
								this.scale.x -= 6.0 * jumpStart.deltaTime;
								this.scale.y -= 6.0 * jumpStart.deltaTime;
								this.scale.z -= 6.0 * jumpStart.deltaTime;
							}

							this.rotateX(this.userData.direction.x * jumpStart.deltaTime);
							this.rotateY(this.userData.direction.y * jumpStart.deltaTime);
							this.rotateZ(this.userData.direction.z * jumpStart.deltaTime);

							this.translateZ(15.0 * jumpStart.deltaTime);
							this.position.y += 10.0 * jumpStart.deltaTime;

							if( this.scale.x <= 0.1 )
								jumpStart.removeInstance(this);
						}
						else
						{
							this.translateZ(200.0 * jumpStart.deltaTime);
						}
					});
				}
				*/
			}

			function collectCoin()
			{
			//	myCar.syncData.score++;
			//	myCar.sync({"syncData": true});
				jumpStart.removeInstance(this);
			}

			function coinTick()
			{
				this.rotateY(2.0 * jumpStart.deltaTime);

				if( !!hawk && hawk.position.distanceTo(this.getWorldPosition()) < 1.0 )
				{
					collectCoin.call(this);
				}
			}

			function coinSpawn()
			{
			//	coins[this.uuid] = this;
			}

			function growTick()
			{
				this.rotateY(2.0 * jumpStart.deltaTime);

				this.scale.set(this.scale.x + (1.0 * jumpStart.deltaTime), this.scale.y + (1.0 * jumpStart.deltaTime), this.scale.z + (1.0 * jumpStart.deltaTime));

				if( this.scale.x >= this.userData.maxGrowScale )
				{
					this.scale.set(this.userData.maxGrowScale, this.userData.maxGrowScale, this.userData.maxGrowScale);
					this.removeEventListener("tick", arguments.callee);
				}
			}
		</script>
	</head>

	<body>
	</body>
</html>